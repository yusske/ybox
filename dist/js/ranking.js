/*! ybox 2015-03-04 */
!function(a){{var b=Backbone.Model.extend({defaults:{id:"0",songName:"empty",creationDate:"",comparator:0,counter:1,status:"new"}}),c=Backbone.Collection.extend({model:b,url:"http://"+window.location.host+"/ybox/service/getplaylist.php",parse:function(a){return a.output}}),d=Backbone.View.extend({tagName:"li",className:"js-checksong ui-btn ui-btn-icon-right ui-icon-check",events:{"click div.swap":"swap","click span.delete":"remove"},attributes:{"data-icon":"check"},initialize:function(){_.bindAll(this,"render","unrender","swap","remove"),this.model.bind("change",this.render),this.model.bind("remove",this.unrender)},render:function(){var b=this;return a.get("tweetsTemplate.html",function(a){b.template=_.template(a,{})},"html").done(function(){b.onSucess()}),this},unrender:function(){a(this.el).remove()},swap:function(){console.log("swap"),a(this.el).toggleClass("ui-btn-b");var b=this,c="played"!=this.model.attributes.status?"played":"new";a.ajax({url:"http://"+window.location.host+"/ybox/service/checksong.php",type:"GET",data:{id:this.model.id,s:c},success:function(c){"played"===c.output.status&&a(b.el).addlCass("ui-btn-b")},error:function(){console.log("error...")}})},remove:function(){this.model.destroy()},onSucess:function(){return a(this.el).html(this.template({song:this.model.toJSON()})),"played"==this.model.attributes.status&&a(this.el).addClass("ui-btn-b"),this}}),e=Backbone.View.extend({el:a("body"),events:{"click button#clear":"clearList","click .js-checksong":"checkSong"},initialize:function(){_.bindAll(this,"render","updateCounter");var a=this;this.getSongs(),setInterval(function(){a.getSongs()},15e3)},getSongs:function(){var a=new c;a.comparator=function(a){return-a.get("counter")};var b=this;a.fetch({success:function(a,c){console.log(c),b.collection=a,b.counter=0,b.render()},error:function(a){console.log(a)}})},clearList:function(){var b=this;a.ajax({url:"http://"+window.location.host+"/ybox/service/clearplaylist.php",type:"post",success:function(){b.getSongs()},error:function(){console.log("error...")}})},render:function(){a("#playlist").empty();var b=this;_(this.collection.models).each(function(a){b.appendItem(a)},this)},appendItem:function(b){var c=new d({model:b});a("#playlist",this.el).append(c.render().el),a("#playlist").listview("refresh")},updateCounter:function(){var a=Math.random()*this.collection.length,b=Math.floor(a),c=this.collection.models[b].get("counter");c++,this.collection.models[b].set({counter:c}),this.collection.sort(),this.render()}});new e}}(jQuery);